{
  "functions": {
    "DEAL_ENCOUNTER_CARD": {
      "args": [
        {"$FACE_UP": false},
        {"$GROUP_ID": "sharedEncounterDeck"},
        {"$PLAYER": "$PLAYER_N"}
      ],
      "code": [
        ["VAR", "$GROUP", "$GAME.groupById.$GROUP_ID"],
        ["COND",
          ["EQUAL", ["LENGTH", "$GROUP.stackIds"], 0],
          ["LOG", "{{$GROUP.label}} is empty."],
          true,
          [
            ["VAR", "$CARD_ID", ["GET_CARD_ID", "$GROUP_ID", 0, 0]],
            ["MOVE_CARD", "$CARD_ID", "{{$PLAYER}}Engaged", -1, 0, ["PROCESS_MAP", {"allowFlip": "$FACE_UP"}]],
            ["COND",
              ["DEFINED", "$ALIAS_N"],
              ["LOG", "{{$ALIAS_N}} dealt an encounter card."],
              true,
              ["LOG", "An ecounter card was dealt."]
            ]
          ]
        ]
      ]
    },
    "DISCARD_CARD": {
      "args": ["$DISCARD_CARD_ID"],
      "code": [
        ["VAR", "$DISCARD_CARD", "$GAME.cardById.$DISCARD_CARD_ID"],
        ["COND",
          ["EQUAL", "$DISCARD_CARD.discardGroupId", null],
          ["LOG", "{{$ALIAS_N}} failed to discard {{$DISCARD_CARD.currentFace.name}} because it is not associated with a discard pile. Please drag the card instead."],
          true,
          [
            ["LOG", "{{$ALIAS_N}} discarded {{$DISCARD_CARD.currentFace.name}}."],
            ["SET", "/cardById/$DISCARD_CARD.id/rotation", 0],
            ["MOVE_CARD", "$DISCARD_CARD.id", "$DISCARD_CARD.discardGroupId", 0],
            ["COND",
              ["AND",
                ["EQUAL", "$DISCARD_CARD.sides.A.type", "Villain"],
                ["GREATER_THAN", ["LENGTH", "$GAME.groupById.sharedVillainDeck.stackIds"], 0]
              ],
              [
                ["VAR", "$CARD_ID", "$GAME.groupById.sharedVillainDeck.parentCardIds.[0]"],
                ["MOVE_CARD", "$CARD_ID", "sharedVillain", 0],
                ["SET_VILLAIN_HEALTH", "$CARD_ID"]
              ]
            ],
            ["COND",
              ["AND",
                ["EQUAL", "$DISCARD_CARD.sides.A.type", "Main Scheme"],
                ["GREATER_THAN", ["LENGTH", "$GAME.groupById.sharedMainSchemeDeck.stackIds"], 0]
              ],
              [
                ["VAR", "$CARD_ID", "$GAME.groupById.sharedMainSchemeDeck.parentCardIds.[0]"],
                ["MOVE_CARD", "$CARD_ID", "sharedMainScheme", 0],
                ["SET_SCHEME_STARTING_THREAT", "$CARD_ID"]
              ]
            ]
          ]
        ]
      ]
    },
    "DISCARD_UNTIL": {
      "args": ["$SOURCE_GROUP_ID", "$DEST_GROUP_ID", "$COND"],
      "code": [
        ["VAR", "$CARD_ID", "$GAME.groupById.$SOURCE_GROUP_ID.parentCardIds.[0]"],
        ["VAR", "$CARD", "$GAME.cardById.$CARD_ID"],
        ["WHILE",
          ["AND",
            ["NOT", ["ACTION_LIST", "$COND"]],
            ["GREATER_THAN", ["LENGTH", "$GAME.groupById.$SOURCE_GROUP_ID.stackIds"], 1]
          ],
          [
            ["DISCARD_CARD", "$CARD_ID"],
            ["VAR", "$CARD_ID", "$GAME.groupById.$SOURCE_GROUP_ID.parentCardIds.[0]"],
            ["VAR", "$CARD", "$GAME.cardById.$CARD_ID"]
          ]
        ],
        ["VAR", "$CARD_ID", "$GAME.groupById.$SOURCE_GROUP_ID.parentCardIds.[0]"],
        ["VAR", "$CARD", "$GAME.cardById.$CARD_ID"],
        ["COND",
          ["ACTION_LIST", "$COND"],
          ["MOVE_CARD", "$CARD_ID", "$DEST_GROUP_ID", 0],
          true,
          ["DISCARD_CARD", "$CARD_ID"]
        ]
      ]
    },
    "LOAD_REQUIRED": {
      "args": ["$SCENARIO"],
      "code": ["COND",
        "$GAME.loadRequired",
        ["LOAD_CARDS", "{{$SCENARIO}} (required)"]
      ]
    },
    "SET_MODE": {
      "args": ["$MODE"],
      "code": [
        ["SET", "/mode", "$MODE"],
        ["LOG", "Mode is set to ", "$MODE"]
      ]
    },
    "SET_SIDE": {
      "args": ["$PLAYER", "$CARD_ID", "$SIDE"],
      "code": [
        ["VAR", "$CARD", "$GAME.cardById.$CARD_ID"],
        ["LOG", "{{$PLAYER}} changed {{$CARD.currentFace.name}} ({{$CARD.currentSide}}) to {{$CARD.sides.$SIDE.name}} ({{$SIDE}})."],
        ["SET", "/cardById/$CARD_ID/currentSide", "$SIDE"]
      ]
    },
    "SET_SCHEME_STARTING_THREAT": {
      "args": ["$CARD_ID"],
      "code": [
        ["VAR", "$CARD", "$GAME.cardById.$CARD_ID"],
        ["DEFINE", "$STARTING_THREAT", 0],
        ["COND",
          ["EQUAL", "$CARD.sides.A.type", "Main Scheme"],
          ["VAR", "$SCHEME_FACE", "B"],
          true,
          ["VAR", "$SCHEME_FACE", "A"]
        ],
        ["COND",
          ["NOT_EQUAL", "$CARD.sides.$SCHEME_FACE.startingThreatFixed", null],
          ["VAR", "$STARTING_THREAT", ["ADD", "$STARTING_THREAT", "$CARD.sides.$SCHEME_FACE.startingThreatFixed"]]
        ],
        ["COND",
          ["NOT_EQUAL", "$CARD.sides.$SCHEME_FACE.startingThreatScaling", null],
          ["VAR", "$STARTING_THREAT", ["ADD", "$STARTING_THREAT", ["MULTIPLY", "$CARD.sides.$SCHEME_FACE.startingThreatScaling", "$GAME.numPlayers"]]]
        ],
        [
          ["LOG", "Setting starting threat for ${{$CARD.sides.$SCHEME_FACE.name}} to {{$STARTING_THREAT}}."],
          ["SET", "/cardById/$CARD_ID/tokens/threat", "$STARTING_THREAT"]
        ]
      ]
    },
    "SET_VILLAIN_HEALTH": {
      "args": ["$CARD_ID", {"$INCREASE_HIT_POINTS": 0}],
      "code": [
        ["VAR", "$CARD", "$GAME.cardById.$CARD_ID"],
        ["VAR", "$HIT_POINTS", -1],
        ["COND",
          ["NOT_EQUAL", "$CARD.sides.A.hitPointsFixed", null],
          ["VAR", "$HIT_POINTS", "$CARD.sides.A.hitPointsFixed"],
          ["NOT_EQUAL", "$CARD.sides.A.hitPointsScaling", null],
          ["VAR", "$HIT_POINTS", ["MULTIPLY", "$CARD.sides.A.hitPointsScaling", "$GAME.numPlayers"]]
        ],
        ["COND",
          ["GREATER_THAN", "$INCREASE_HIT_POINTS", 0],
          ["VAR", "$HIT_POINTS", ["ADD", "$HIT_POINTS", "$INCREASE_HIT_POINTS"]]
        ],
        ["LOG", "Set villain hit points to {{$HIT_POINTS}}."],
        ["SET", "/villainHitPoints", "$HIT_POINTS"]
      ]
    }
  }
}
